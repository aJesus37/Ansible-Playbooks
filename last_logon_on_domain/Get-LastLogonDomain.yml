---
    - name: Get all the users in a windows domain
      hosts: server
      gather_facts: no
      tasks:

        - name: (Re)Create empty file for storage of information
          local_action:
            module: copy
            dest: /tmp/domain_users.csv
            content: '"username","active","lastLogon"'
          run_once: True

        - name: Get the users in domain
          script:  '/etc/ansible/playbooks/last_logon_on_domain/Get-LastLogonDomain.ps1'
          register: users

        - name: Show content on screen
          debug: 
            msg: "{{ users.stdout }}"

        - name: send content to file
          lineinfile:
            line: "{{ users.stdout | string }}"
            dest: /tmp/domain_users.csv
            insertafter: EOF
          delegate_to: localhost

        - name: Remove empty lines in csv
          replace:
            path: /tmp/domain_users.csv
            regexp: '(^\s*$\n)'
            replace: ''
          delegate_to: localhost
          run_once: True

        - name: Check if playbook_results exists
          stat:
            path: /tmp/playbook_results
          register: folder_details

        - name: Create folder if it doesn't exists
          command: mkdir -p /tmp/playbook_results
          when: folder_details.stat.exists == false

        - name: Move result to playbook_results
          command: mv -f /tmp/domain_users.csv /tmp/playbook_results/domain_users.csv